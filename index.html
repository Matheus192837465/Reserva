<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva Pro SaaS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; }
        .shimmer {
            background: linear-gradient(90deg, #eff1f3 25%, #e2e8f0 50%, #eff1f3 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .active-link { border-left: 4px solid #3B82F6; background: #EFF6FF; color: #1D4ED8; }
    </style>
</head>
<body class="flex flex-col md:flex-row min-h-screen">

    <!-- Sidebar -->
    <nav class="w-full md:w-64 bg-white border-r border-gray-200 p-6 flex flex-col">
        <div class="flex items-center gap-3 mb-10 text-blue-600">
            <i class="fas fa-layer-group text-2xl"></i>
            <span class="text-xl font-bold text-gray-800 tracking-tight">FocusRoom</span>
        </div>
        <div class="space-y-2 flex-1">
            <button onclick="showSection('dash')" id="nav-dash" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition active-link">
                <i class="fas fa-home"></i> Dashboard
            </button>
            <button onclick="showSection('book')" id="nav-book" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition text-gray-500 hover:bg-gray-50">
                <i class="fas fa-calendar-plus"></i> Nova Reserva
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 p-6 md:p-12 overflow-y-auto">
        
        <!-- SECTION DASHBOARD -->
        <section id="sec-dash">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <p class="text-sm font-semibold text-gray-400 uppercase">Hoje</p>
                    <h2 id="dash-total" class="text-3xl font-bold text-gray-800">--</h2>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <p class="text-sm font-semibold text-gray-400 uppercase">Próximo</p>
                    <h2 id="dash-next" class="text-3xl font-bold text-blue-600">--</h2>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <p class="text-sm font-semibold text-gray-400 uppercase">Status</p>
                    <h2 class="text-3xl font-bold text-green-500 italic">Online</h2>
                </div>
            </div>

            <h3 class="text-lg font-bold mb-4 text-gray-700">Agenda do Dia</h3>
            <div id="dash-list" class="space-y-3">
                <!-- Skeletons -->
                <div class="shimmer h-20 rounded-2xl"></div>
                <div class="shimmer h-20 rounded-2xl"></div>
            </div>
        </section>

        <!-- SECTION BOOKING -->
        <section id="sec-book" class="hidden max-w-2xl mx-auto">
            <div class="bg-white rounded-3xl shadow-sm border border-gray-100 p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Reservar Horário</h2>
                
                <label class="block text-sm font-bold text-gray-500 uppercase mb-2">Data</label>
                <input type="date" id="input-date" onchange="fetchOccupiedSlots()" class="w-full mb-8 p-4 bg-gray-50 border-none rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none font-semibold">

                <label class="block text-sm font-bold text-gray-500 uppercase mb-4">Escolha o Horário (15 min)</label>
                <div id="grid-slots" class="grid grid-cols-3 sm:grid-cols-4 gap-3 mb-8">
                    <!-- Slots dinâmicos -->
                </div>

                <button id="btn-confirm" onclick="submitBooking()" disabled class="w-full py-4 bg-blue-600 text-white rounded-2xl font-bold text-lg shadow-lg shadow-blue-200 disabled:opacity-30 disabled:shadow-none transition-all">
                    Confirmar Agendamento
                </button>
            </div>
        </section>
    </main>

    <script>
        // --- CONFIGURAÇÃO ---
        const API_URL = "https://script.google.com/macros/s/AKfycbwoPvQuLU7Ov1gFiFXyqIOkTwxO5WRej64oy5jRqq0sm-FQ2fmENCPRTSw4Hs766_dY/exec"; 
        
        let selectedTime = null;
        let occupiedTimes = [];

        async function apiGet(params) {
            try {
                // Adicionamos 'redirect: "follow"' para garantir que ele siga o 302 do Google
                const response = await fetch(${API_URL}?${params}, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error('Network response was not ok');
                
                return await response.json();
            } catch (error) {
                console.error("Erro na API:", error);
                throw error;
            }
        }

        // --- DASHBOARD LOGIC ---
        async function loadDashboard() {
            const list = document.getElementById('dash-list');
            try {
                const data = await apiGet('action=getDashboard');
                document.getElementById('dash-total').innerText = data.total;
                document.getElementById('dash-next').innerText = data.next;

                if (data.bookings.length === 0) {
                    list.innerHTML = `<div class="p-10 text-center text-gray-400 bg-white rounded-2xl border-2 border-dashed">Nenhuma reserva para hoje</div>`;
                    return;
                }

                list.innerHTML = data.bookings.map(b => `
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 flex justify-between items-center shadow-sm">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center font-bold">${b.time[0]}${b.time[1]}</div>
                            <div>
                                <h4 class="font-bold text-gray-800">${b.user}</h4>
                                <p class="text-sm text-gray-400">Sala de Reunião Individual</p>
                            </div>
                        </div>
                        <span class="font-bold text-blue-600 bg-blue-50 px-4 py-1 rounded-full">${b.time}</span>
                    </div>
                `).join('');
            } catch (e) {
                console.error("Erro ao carregar dashboard", e);
            }
        }

        // --- BOOKING LOGIC ---
        function generateTimeSlots() {
            const slots = [];
            for (let hour = 8; hour <= 18; hour++) {
                ["00", "15", "30", "45"].forEach(min => {
                    slots.push(`${hour.toString().padStart(2, '0')}:${min}`);
                });
            }
            return slots;
        }

        async function fetchOccupiedSlots() {
        const date = document.getElementById('input-date').value;
        if(!date) return;
    
        const grid = document.getElementById('grid-slots');
        grid.innerHTML = Array(8).fill('<div class="shimmer h-12 rounded-xl"></div>').join('');
        
        try {
            const data = await apiGet(action=getSlots&date=${date});
            occupiedTimes = data.occupied || [];
            renderGrid();
        } catch (e) {
            toast("Erro ao carregar horários. Verifique o console.", "#EF4444");
            grid.innerHTML = <p class="col-span-full text-center text-red-500 text-sm">Erro de conexão com o Google Script.</p>;
        }
    }

        function renderGrid() {
            const grid = document.getElementById('grid-slots');
            const allSlots = generateTimeSlots();
            
            grid.innerHTML = allSlots.map(time => {
                const isOccupied = occupiedTimes.includes(time);
                const isSelected = selectedTime === time;
                
                return `
                    <button 
                        ${isOccupied ? 'disabled' : ''} 
                        onclick="selectTime('${time}')"
                        class="p-3 rounded-xl border-2 font-bold text-sm transition-all
                        ${isOccupied ? 'bg-gray-100 border-gray-100 text-gray-300 line-through cursor-not-allowed' : 
                          isSelected ? 'bg-blue-600 border-blue-600 text-white shadow-md' : 
                          'bg-white border-gray-100 text-gray-600 hover:border-blue-300 hover:bg-blue-50'}">
                        ${time}
                    </button>
                `;
            }).join('');
        }

        function selectTime(time) {
            selectedTime = time;
            document.getElementById('btn-confirm').disabled = false;
            renderGrid();
        }

        async function submitBooking() {
            const btn = document.getElementById('btn-confirm');
            const date = document.getElementById('input-date').value;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reservando...';

            try {
                // Google Apps Script exige fetch com POST e body stringificado
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Necessário para evitar erro de redirecionamento CORS do Google
                    body: JSON.stringify({ date, time: selectedTime })
                });

                toast("Reserva realizada com sucesso!", "#10B981");
                selectedTime = null;
                setTimeout(() => {
                    showSection('dash');
                    loadDashboard();
                }, 1500);
            } catch (e) {
                toast("Erro ao processar reserva", "#EF4444");
                btn.disabled = false;
            }
        }

        // --- UI UTILS ---
        function showSection(sec) {
            document.getElementById('sec-dash').classList.toggle('hidden', sec !== 'dash');
            document.getElementById('sec-book').classList.toggle('hidden', sec !== 'book');
            document.getElementById('nav-dash').classList.toggle('active-link', sec === 'dash');
            document.getElementById('nav-book').classList.toggle('active-link', sec === 'book');
        }

        function toast(msg, color) {
            Toastify({ text: msg, duration: 3000, style: { background: color, borderRadius: "12px" } }).showToast();
        }

        // Init
        window.onload = () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('input-date').value = today;
            document.getElementById('input-date').min = today;
            loadDashboard();
        };
    </script>
</body>
</html>
